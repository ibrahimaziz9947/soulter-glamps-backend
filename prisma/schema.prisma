generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum Role {
  SUPER_ADMIN
  ADMIN
  AGENT
  CUSTOMER
}

enum GlampStatus {
  ACTIVE
  INACTIVE
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum CommissionStatus {
  UNPAID
  PAID
}

enum ExpenseStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
  CANCELLED
}

enum ExpenseApprovalAction {
  CREATE
  UPDATE
  SUBMIT
  APPROVE
  REJECT
  CANCEL
  DELETE
}

// ============================================
// USER MODEL
// ============================================
// Represents all system users: customers, agents, admins, super admins
// 
// CUSTOMER Lifecycle:
// - CUSTOMER users are created dynamically during booking flow
// - They do NOT require login credentials (business entities, not operators)
// - CUSTOMER deletion is allowed and will CASCADE to their bookings
// - Only SUPER_ADMIN, ADMIN, and AGENT are seeded with credentials
model User {
  id       String  @id @default(uuid())
  name     String
  email    String  @unique
  password String // Hashed with bcrypt
  role     Role    @default(CUSTOMER)
  active   Boolean @default(true)

  // Relations
  customerBookings Booking[]    @relation("CustomerBookings") // Bookings made as customer
  agentBookings    Booking[]    @relation("AgentBookings") // Bookings referred as agent
  commissions      Commission[] // Commissions earned as agent

  // Finance relations
  expensesCreated   Expense[] @relation("ExpenseCreator")
  expensesUpdated   Expense[] @relation("ExpenseUpdater")
  expensesSubmitted Expense[] @relation("ExpenseSubmittedBy")
  expensesApproved  Expense[] @relation("ExpenseApprovedBy")
  expensesRejected  Expense[] @relation("ExpenseRejectedBy")

  // Expense approval events
  expenseApprovalEvents ExpenseApprovalEvent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([role])
}

// ============================================
// GLAMP MODEL
// ============================================
// Represents a glamping property available for booking
model Glamp {
  id            String      @id @default(uuid())
  name          String
  description   String?
  pricePerNight Int // Price in smallest currency unit (e.g., cents)
  maxGuests     Int
  status        GlampStatus @default(ACTIVE)
  features      String[]    @default([]) // List of features (e.g., ["WiFi", "Pool"])
  amenities     String[]    @default([]) // List of amenities (e.g., ["

  // Relations
  bookings Booking[] // All bookings for this glamp

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
}

// ============================================
// BOOKING MODEL
// ============================================
// Represents a reservation made by a customer for a glamp
model Booking {
  id           String        @id @default(uuid())
  checkInDate  DateTime
  checkOutDate DateTime
  guests       Int           @default(1) // Number of guests
  totalAmount  Int // Total booking amount in smallest currency unit
  status       BookingStatus @default(PENDING)

  // Relations
  customer   User   @relation("CustomerBookings", fields: [customerId], references: [id], onDelete: Cascade)
  customerId String

  agent   User?   @relation("AgentBookings", fields: [agentId], references: [id], onDelete: SetNull)
  agentId String? // Optional: agent who referred this booking

  glamp   Glamp  @relation(fields: [glampId], references: [id], onDelete: Cascade)
  glampId String

  // Snapshot fields for admin readability (denormalized for performance)
  customerName String @default("Unknown") // Snapshot of customer name at booking time
  glampName    String @default("Unknown") // Snapshot of glamp name at booking time

  commission Commission? // Commission generated for this booking (if agent involved)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([agentId])
  @@index([glampId])
  @@index([status])
  @@index([checkInDate])
}

// ============================================
// COMMISSION MODEL
// ============================================
// Represents commission earned by an agent for referring a booking
model Commission {
  id     String           @id @default(uuid())
  amount Int // Commission amount in smallest currency unit
  status CommissionStatus @default(UNPAID) // Payment status

  // Relations
  agent   User   @relation(fields: [agentId], references: [id], onDelete: Cascade)
  agentId String

  booking   Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  bookingId String  @unique // One commission per booking

  createdAt DateTime @default(now())

  @@index([agentId])
  @@index([bookingId])
  @@index([status])
}

// ============================================
// EXPENSE CATEGORY MODEL
// ============================================
// Represents categories for organizing expenses
model ExpenseCategory {
  id          String  @id @default(uuid())
  name        String  @unique
  description String?
  active      Boolean @default(true)

  // Relations
  expenses Expense[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([active])
  @@index([name])
}

// ============================================
// EXPENSE MODEL
// ============================================
// Represents business expenses with audit trail and soft delete support
model Expense {
  id          String        @id @default(uuid())
  title       String
  description String?
  amount      Int // Amount in smallest currency unit (e.g., cents)
  date        DateTime      @default(now())
  vendor      String?
  receiptUrl  String?
  status      ExpenseStatus @default(DRAFT)

  // Relations
  category   ExpenseCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  categoryId String?

  createdBy   User   @relation("ExpenseCreator", fields: [createdById], references: [id], onDelete: SetNull)
  createdById String

  updatedBy   User?   @relation("ExpenseUpdater", fields: [updatedById], references: [id], onDelete: SetNull)
  updatedById String?

  // Submission workflow
  submittedAt   DateTime?
  submittedBy   User?     @relation("ExpenseSubmittedBy", fields: [submittedById], references: [id], onDelete: SetNull)
  submittedById String?

  // Approval workflow
  approvedAt      DateTime?
  approvedBy      User?     @relation("ExpenseApprovedBy", fields: [approvedById], references: [id], onDelete: SetNull)
  approvedById    String?
  approvalComment String?

  // Rejection workflow
  rejectedAt      DateTime?
  rejectedBy      User?     @relation("ExpenseRejectedBy", fields: [rejectedById], references: [id], onDelete: SetNull)
  rejectedById    String?
  rejectionReason String?

  // Soft delete
  deletedAt DateTime?

  // Approval history
  approvalEvents ExpenseApprovalEvent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([categoryId])
  @@index([createdById])
  @@index([status])
  @@index([date])
  @@index([deletedAt])
  @@index([submittedAt])
  @@index([approvedAt])
}

// ============================================
// EXPENSE APPROVAL EVENT MODEL
// ============================================
// Audit trail for expense approval workflow actions
model ExpenseApprovalEvent {
  id         String                @id @default(uuid())
  action     ExpenseApprovalAction
  fromStatus ExpenseStatus?
  toStatus   ExpenseStatus
  comment    String?

  // Relations
  expense   Expense @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  expenseId String

  performedBy   User   @relation(fields: [performedById], references: [id], onDelete: SetNull)
  performedById String

  createdAt DateTime @default(now())

  @@index([expenseId])
  @@index([performedById])
  @@index([action])
  @@index([createdAt])
}
