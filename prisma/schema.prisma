generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum Role {
  SUPER_ADMIN
  ADMIN
  AGENT
  CUSTOMER
}

enum GlampStatus {
  ACTIVE
  INACTIVE
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum CommissionStatus {
  UNPAID
  PAID
}

// ============================================
// USER MODEL
// ============================================
// Represents all system users: customers, agents, admins, super admins
// 
// CUSTOMER Lifecycle:
// - CUSTOMER users are created dynamically during booking flow
// - They do NOT require login credentials (business entities, not operators)
// - CUSTOMER deletion is allowed and will CASCADE to their bookings
// - Only SUPER_ADMIN, ADMIN, and AGENT are seeded with credentials
model User {
  id       String  @id @default(uuid())
  name     String
  email    String  @unique
  password String // Hashed with bcrypt
  role     Role    @default(CUSTOMER)
  active   Boolean @default(true)

  // Relations
  customerBookings Booking[]    @relation("CustomerBookings") // Bookings made as customer
  agentBookings    Booking[]    @relation("AgentBookings") // Bookings referred as agent
  commissions      Commission[] // Commissions earned as agent

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([role])
}

// ============================================
// GLAMP MODEL
// ============================================
// Represents a glamping property available for booking
model Glamp {
  id            String      @id @default(uuid())
  name          String
  description   String?
  pricePerNight Int // Price in smallest currency unit (e.g., cents)
  maxGuests     Int
  status        GlampStatus @default(ACTIVE)
  features      String[]    @default([]) // List of features (e.g., ["WiFi", "Pool"])
  amenities     String[]    @default([]) // List of amenities (e.g., ["

  // Relations
  bookings Booking[] // All bookings for this glamp

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
}

// ============================================
// BOOKING MODEL
// ============================================
// Represents a reservation made by a customer for a glamp
model Booking {
  id           String        @id @default(uuid())
  checkInDate  DateTime
  checkOutDate DateTime
  guests       Int           @default(1) // Number of guests
  totalAmount  Int // Total booking amount in smallest currency unit
  status       BookingStatus @default(PENDING)

  // Relations
  customer   User   @relation("CustomerBookings", fields: [customerId], references: [id], onDelete: Cascade)
  customerId String

  agent   User?   @relation("AgentBookings", fields: [agentId], references: [id], onDelete: SetNull)
  agentId String? // Optional: agent who referred this booking

  glamp   Glamp  @relation(fields: [glampId], references: [id], onDelete: Cascade)
  glampId String

  // Snapshot fields for admin readability (denormalized for performance)
  customerName String @default("Unknown") // Snapshot of customer name at booking time
  glampName    String @default("Unknown") // Snapshot of glamp name at booking time

  commission Commission? // Commission generated for this booking (if agent involved)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([agentId])
  @@index([glampId])
  @@index([status])
  @@index([checkInDate])
}

// ============================================
// COMMISSION MODEL
// ============================================
// Represents commission earned by an agent for referring a booking
model Commission {
  id     String           @id @default(uuid())
  amount Int // Commission amount in smallest currency unit
  status CommissionStatus @default(UNPAID) // Payment status

  // Relations
  agent   User   @relation(fields: [agentId], references: [id], onDelete: Cascade)
  agentId String

  booking   Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  bookingId String  @unique // One commission per booking

  createdAt DateTime @default(now())

  @@index([agentId])
  @@index([bookingId])
  @@index([status])
}
