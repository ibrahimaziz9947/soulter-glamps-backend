generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String                 @id @default(uuid())
  name                  String
  email                 String?                @unique
  phone                 String?                @unique
  password              String
  role                  Role                   @default(CUSTOMER)
  active                Boolean                @default(true)
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  agentBookings         Booking[]              @relation("AgentBookings")
  customerBookings      Booking[]              @relation("CustomerBookings")
  commissions           Commission[]
  expensesApproved      Expense[]              @relation("ExpenseApprovedBy")
  expensesCreated       Expense[]              @relation("ExpenseCreator")
  expensesRejected      Expense[]              @relation("ExpenseRejectedBy")
  expensesSubmitted     Expense[]              @relation("ExpenseSubmittedBy")
  expensesUpdated       Expense[]              @relation("ExpenseUpdater")
  expenseApprovalEvents ExpenseApprovalEvent[]
  incomesCreated        Income[]               @relation("IncomeCreator")
  incomesUpdated        Income[]               @relation("IncomeUpdater")
  purchasesCreated      Purchase[]             @relation("PurchaseCreator")
  purchasesUpdated      Purchase[]             @relation("PurchaseUpdater")

  @@index([email])
  @@index([role])
}

model Glamp {
  id            String      @id @default(uuid())
  name          String
  description   String?
  pricePerNight Int
  maxGuests     Int
  status        GlampStatus @default(ACTIVE)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  amenities     String[]    @default([])
  features      String[]    @default([])
  imageUrl      String?
  isTest        Boolean     @default(false)
  availability  Boolean     @default(true)
  bookings      Booking[]
  bookingItems  BookingItem[]

  @@index([status])
  @@index([isTest])
  @@index([availability])
}

model Booking {
  id           String        @id @default(uuid())
  checkInDate  DateTime
  checkOutDate DateTime
  guests       Int           @default(1)
  totalAmount  Int
  status       BookingStatus @default(PENDING)
  customerId   String
  agentId      String?
  glampId      String
  customerName String        @default("Unknown")
  glampName    String        @default("Unknown")
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  agent        User?         @relation("AgentBookings", fields: [agentId], references: [id])
  customer     User          @relation("CustomerBookings", fields: [customerId], references: [id], onDelete: Cascade)
  glamp        Glamp         @relation(fields: [glampId], references: [id], onDelete: Cascade)
  items        BookingItem[]
  commission   Commission?
  incomes      Income[]

  @@index([customerId])
  @@index([agentId])
  @@index([glampId])
  @@index([status])
  @@index([checkInDate])
}

model BookingItem {
  id        String   @id @default(uuid())
  bookingId String
  booking   Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  glampId   String
  glamp     Glamp    @relation(fields: [glampId], references: [id])
  price     Int      // Snapshot price at booking time
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([bookingId])
  @@index([glampId])
}

model Commission {
  id        String           @id @default(uuid())
  amount    Int
  agentId   String
  bookingId String           @unique
  createdAt DateTime         @default(now())
  status    CommissionStatus @default(UNPAID)
  agent     User             @relation(fields: [agentId], references: [id], onDelete: Cascade)
  booking   Booking          @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([bookingId])
  @@index([status])
}

model ExpenseCategory {
  id          String    @id @default(uuid())
  name        String    @unique
  description String?
  active      Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  expenses    Expense[]

  @@index([active])
  @@index([name])
}

model Expense {
  id              String                 @id @default(uuid())
  title           String
  description     String?
  amount          Int
  date            DateTime               @default(now())
  vendor          String?
  receiptUrl      String?
  categoryId      String?
  createdById     String
  updatedById     String?
  deletedAt       DateTime?
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  approvalComment String?
  approvedAt      DateTime?
  approvedById    String?
  rejectedAt      DateTime?
  rejectedById    String?
  rejectionReason String?
  status          ExpenseStatus          @default(DRAFT)
  submittedAt     DateTime?
  submittedById   String?
  approvedBy      User?                  @relation("ExpenseApprovedBy", fields: [approvedById], references: [id])
  category        ExpenseCategory?       @relation(fields: [categoryId], references: [id])
  createdBy       User                   @relation("ExpenseCreator", fields: [createdById], references: [id], onDelete: SetNull)
  rejectedBy      User?                  @relation("ExpenseRejectedBy", fields: [rejectedById], references: [id])
  submittedBy     User?                  @relation("ExpenseSubmittedBy", fields: [submittedById], references: [id])
  updatedBy       User?                  @relation("ExpenseUpdater", fields: [updatedById], references: [id])
  approvalEvents  ExpenseApprovalEvent[]

  @@index([categoryId])
  @@index([createdById])
  @@index([status])
  @@index([date])
  @@index([deletedAt])
  @@index([submittedAt])
  @@index([approvedAt])
}

model ExpenseApprovalEvent {
  id            String                @id @default(uuid())
  action        ExpenseApprovalAction
  fromStatus    ExpenseStatus?
  toStatus      ExpenseStatus
  comment       String?
  expenseId     String
  performedById String
  createdAt     DateTime              @default(now())
  expense       Expense               @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  performedBy   User                  @relation(fields: [performedById], references: [id], onDelete: SetNull)

  @@index([expenseId])
  @@index([performedById])
  @@index([action])
  @@index([createdAt])
}

model Income {
  id           String       @id @default(uuid())
  amount       Int
  currency     String       @default("USD")
  dateReceived DateTime     @default(now())
  source       IncomeSource
  status       IncomeStatus @default(CONFIRMED)
  reference    String?
  notes        String?
  bookingId    String?
  createdById  String
  updatedById  String?
  deletedAt    DateTime?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  booking      Booking?     @relation(fields: [bookingId], references: [id])
  createdBy    User         @relation("IncomeCreator", fields: [createdById], references: [id], onDelete: SetNull)
  updatedBy    User?        @relation("IncomeUpdater", fields: [updatedById], references: [id])

  @@index([bookingId])
  @@index([dateReceived])
  @@index([source])
  @@index([status])
  @@index([deletedAt])
  @@index([createdById])
}

model Purchase {
  id              String                @id @default(uuid())
  amount          Int
  currency        String                @default("USD")
  purchaseDate    DateTime
  vendorName      String
  status          PurchaseStatus        @default(DRAFT)
  reference       String?
  notes           String?
  createdById     String
  updatedById     String?
  deletedAt       DateTime?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  paymentStatus   PurchasePaymentStatus @default(UNPAID)
  paidAmountCents Int                   @default(0)
  dueDate         DateTime?
  paidAt          DateTime?
  createdBy       User                  @relation("PurchaseCreator", fields: [createdById], references: [id], onDelete: SetNull)
  updatedBy       User?                 @relation("PurchaseUpdater", fields: [updatedById], references: [id])

  @@index([purchaseDate])
  @@index([vendorName])
  @@index([status])
  @@index([paymentStatus])
  @@index([deletedAt])
  @@index([createdById])
}

enum Role {
  SUPER_ADMIN
  ADMIN
  AGENT
  CUSTOMER
}

enum GlampStatus {
  ACTIVE
  INACTIVE
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum CommissionStatus {
  UNPAID
  PAID
}

enum ExpenseStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
  CANCELLED
}

enum ExpenseApprovalAction {
  CREATE
  UPDATE
  SUBMIT
  APPROVE
  REJECT
  CANCEL
  DELETE
}

enum IncomeSource {
  BOOKING
  MANUAL
  OTHER
}

enum IncomeStatus {
  DRAFT
  CONFIRMED
  CANCELLED
}

enum PurchaseStatus {
  DRAFT
  CONFIRMED
  CANCELLED
}

enum PurchasePaymentStatus {
  UNPAID
  PARTIAL
  PAID
}
